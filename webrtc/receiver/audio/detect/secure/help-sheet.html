<!-- Help side sheet -->
<div id="helpBackdrop" class="help-backdrop"></div>
<aside id="helpSheet" class="help-sheet" aria-labelledby="helpTitle" aria-modal="true" role="dialog">
  <div class="help-header">
    <h3 id="helpTitle">Weighted Top-K – Help</h3>
    <button id="helpClose" class="close" title="Close">×</button>
  </div>

  <div class="help-body" id="helpBody">
    <nav class="help-toc" aria-label="Contents">
      <a href="#tldr">Summary</a>
      <a href="#quickstart">Quick start</a>
      <a href="#cheatsheet">Key controls</a>
      <a href="#troubleshoot">Troubleshooting</a>
      <a href="#learnmore">Learn more</a>
    </nav>

    <section id="tldr" class="help-section">
      <h4>Summary</h4>
      <p class="help-callout">
        Train by streaming mic audio or playing files/folders into YAMNet. We keep running class stats, compute a
        <strong>Top-K</strong> normalized weight vector, and fuse per-class EMAs into a single score with hysteresis.
        Workflow: <em>Train → Recompute Weights → Quiet Calibrate → Start Detect</em>.
      </p>
    </section>

    <section id="quickstart" class="help-section">
      <h4>Quick start</h4>
      <ol>
        <li>Record 20–60s of representative audio for your target(s): <em>Start Training (Mic)</em> or <em>Train on File/Folder</em>.</li>
        <li>Click <strong>Recompute Weights</strong> (saves Top-K weights to the active model).</li>
        <li>Run <strong>Quiet Calibrate</strong> when the room is calm to auto-set detection thresholds.</li>
        <li>Hit <strong>Start Detect</strong> — watch the fused (raw/EMA) chart and the alert pill.</li>
      </ol>
    </section>

    <section id="cheatsheet" class="help-section">
      <h4>Key controls (cheat sheet)</h4>
      <table class="help-kv">
        <tr><th>Top-K classes</th><td>How many non-ignored classes are eligible for weights. We extend past ignored classes to fill K.</td></tr>
        <tr><th>Hybrid prior (kPrior)</th><td>Blends early EMA with running mean while samples are few. Larger = trust EMA longer.</td></tr>
        <tr><th>Hybrid half-life (s)</th><td>Decay for training EMA and presence EMA. Larger = slower adaptation.</td></tr>
        <tr><th>Per-class EMA τ (s)</th><td>Smoothing for class scores used by the fused score.</td></tr>
        <tr><th>Fused EMA τ (s)</th><td>Smoothing on the fused score itself (displayed as red line).</td></tr>
        <tr><th>Min ON hold (ms)</th><td>Keep alert ON for at least this long once tripped.</td></tr>
        <tr><th>Quiet calibration (s)</th><td>Duration to measure the quiet fused baseline.</td></tr>
        <tr><th>OFF delta</th><td>OFF threshold sits this much below ON to avoid flicker.</td></tr>
        <tr><th>Ignore classes</th><td>Exclude during training (by substring). Useful for “Silence/Noise/Inside/Outside”.</td></tr>
        <tr><th>Penalty map</th><td>Subtract weighted EMA for nuisance tokens at inference (e.g., <code>Silence:-0.45</code>).</td></tr>
        <tr><th>Model name</th><td>Use/Load to switch profiles. We persist weights, calibration, ignore and penalty settings per model.</td></tr>
        <tr><th>Recompute Weights</th><td>Locks current Top-K preview into the active model’s weights (used for detection).</td></tr>
        <tr><th>Clear / Export</th><td>Clear wipes model & calibration; Export saves JSON of the model.</td></tr>
        <tr><th>Logs</th><td>Enable top-N or all class dumps every inference for debugging; exportable as JSON.</td></tr>
      </table>
    </section>

    <section id="troubleshoot" class="help-section">
      <h4>Troubleshooting (top 3)</h4>
      <ul>
        <li><strong>No classes or flat lines:</strong> Ensure mic permission granted or a file/folder is playing; wait for MediaPipe to finish loading; check <em>Max results</em> &gt;= 10.</li>
        <li><strong>Weights look empty / wrong focus:</strong> Train longer, include representative positives, then click <em>Recompute Weights</em>. Verify <em>Ignore classes</em> isn’t hiding targets.</li>
        <li><strong>False alerts / missed events:</strong> Run <em>Quiet Calibrate</em>. Increase <em>OFF delta</em> and/or <em>Fused EMA τ</em> for stability; use <em>Penalty map</em> to down-weight noise tokens.</li>
      </ul>
    </section>

    <section id="learnmore" class="help-section">
      <details class="learn-more">
        <summary>Learn more</summary>
        <div style="margin-top:8px">
          <div class="codeblock">
            <strong>Training stats → weights</strong>
            <pre>
mean = sum / n
λ = kPrior / (kPrior + n)
hybrid = (1 − λ)·mean + λ·ema
prevalence = clamp01(emaPresence)
score = max(0, hybrid · (0.5 + 0.5·prevalence))

Pick Top-K by score (ignoring tokens). Normalize:
w_i = score_i / Σ_j score_j
            </pre>

            <strong>Per-class EMA & fused score (detect)</strong>
            <pre>
ema_c,t = ema_c,t−1 + α_class · (score_c − ema_c,t−1)
fused_raw = Σ_c ( w_c · ema_c )
for penalties p(token)=≤0:
  fused_raw += Σ_token p(token) · ema_of_matching_classes
fused = clamp01( fused_raw )
fused_ema = fused_ema_prev + α_fused · (fused − fused_ema_prev)
            </pre>

            <strong>Quiet calibration & hysteresis</strong>
            <pre>
thr_off ≈ min(0.95, p99_quiet + 0.02)
thr_on  ≈ min(0.99, thr_off + off_delta)
ALERT: turn on when fused_ema ≥ thr_on; clear when fused_ema ≤ thr_off,
       with an ON hold of ALERT_HOLD_MS
            </pre>
          </div>
        </div>
      </details>
    </section>
  </div>
</aside>
