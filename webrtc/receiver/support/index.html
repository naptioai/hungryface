<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Email Naptio Support</title>

  <!-- Shared sidebar stylesheet -->
  <link rel="stylesheet" href="/hungryface/webrtc/receiver/shared/sidebar.css" />

  <style>
    :root { color-scheme: dark; }
    html, body { margin:0; height:100%; background:#000; color:#eee; font-family:-apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    /* Let content scroll under a fixed/overlay sidebar */
    body { overflow-x: hidden; }
    .wrap { min-height:100dvh; display:grid; place-items:center; padding:24px; }
    .card { width:min(720px, 92vw); background:#111; border:1px solid #222; border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size:clamp(18px,3vw,22px); margin:4px 0 12px; }
    p.sub { color:#a8a8a8; margin:0 0 12px; }
    .row { display:grid; gap:8px; margin:14px 0; }
    label { font-size:13px; color:#bdbdbd; }
    input[type="text"], textarea { width:100%; box-sizing:border-box; background:#161616; color:#eee; border:1px solid #2a2a2a; border-radius:12px; padding:11px 12px; font-size:15px; outline:none; }
    input[type="text"]:focus, textarea:focus { border-color:#3a3a3a; box-shadow:0 0 0 2px rgba(255,255,255,.05) inset; }
    textarea { min-height:140px; resize:vertical; }

    .drop { border:1.5px dashed #2d2d2d; background:#121212; border-radius:12px; padding:14px; text-align:center; transition:background .15s, border-color .15s; }
    .drop.over { background:#151515; border-color:#444; }
    .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip { display:inline-flex; align-items:center; gap:8px; background:#1a1a1a; border:1px solid #2a2a2a; border-radius:999px; padding:6px 10px; font-size:13px; }
    .chip button { border:none; background:none; color:#bbb; font-size:16px; cursor:pointer; }

    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; align-items:center; }
    .btn { appearance:none; border:1px solid #2a2a2a; background:#2b7cff; color:#fff; padding:12px 16px; border-radius:999px; font-weight:600; cursor:pointer; box-shadow:0 6px 16px rgba(0,0,0,.25); }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .link { appearance:none; border:1px solid #2a2a2a; background:#1a1a1a; color:#eee; padding:10px 14px; border-radius:999px; font-weight:600; cursor:pointer; }

    .hint { font-size:13px; color:#bbb; margin-top:8px; }
    .small { font-size:12px; color:#9a9a9a; }
    .error { color:#ff8a80; font-size:13px; display:none; margin-top:8px; }
    .error.show { display:block; }

    .checkbox { display:flex; align-items:flex-start; gap:10px; font-size:14px; color:#ccc; }
    .checkbox input { margin-top:2px; }

    /* ▼▼ dynamic offset for fixed top drawer/sidebar */
    :root { --nav-offset: 56px; } /* fallback */
    main.wrap {
      padding-top: calc(var(--nav-offset) + env(safe-area-inset-top));
    }
    @supports (height: 100dvh) {
      main.wrap { min-height: calc(100dvh - var(--nav-offset) - env(safe-area-inset-bottom)); }
    }
    /* ▲▲ */

    /* Title row to place copy pill inline with title */
    .title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <!-- ⬇️ Inject shared sidebar markup and behavior (same pattern as your receiver page) -->
  <script type="module">
    (async () => {
      try {
        const res = await fetch('/hungryface/webrtc/receiver/shared/sidebar.html', { cache: 'no-cache' });
        const html = await res.text();
        const wrap = document.createElement('div');
        wrap.innerHTML = html.trim();
        document.body.prepend(...wrap.childNodes);

        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = '/hungryface/webrtc/receiver/shared/sidebar.js';
          s.onload = resolve;
          s.onerror = reject;
          document.body.appendChild(s);
        });
      } catch (err) {
        console.error('[Sidebar] failed to load shared assets:', err);
      }
    })();
  </script>

  <!-- auto-measure topbar height and set --nav-offset -->
  <script>
  (function(){
    const CANDIDATES = [
      '.sidebar-top', '.topbar', '#topbar',
      'header[role="banner"]', 'nav[role="navigation"]'
    ];
    function findTopbar(){
      for (const sel of CANDIDATES) {
        const el = document.querySelector(sel);
        if (el) return el;
      }
      const fixed = [...document.querySelectorAll('body *')].filter(n=>{
        const s = getComputedStyle(n);
        return s.position === 'fixed' && parseInt(s.top||'0',10) === 0 && n.offsetHeight > 30;
      });
      return fixed.sort((a,b)=>b.offsetHeight - a.offsetHeight)[0] || null;
    }
    function applyOffset(topEl){
      const h = Math.ceil(topEl?.getBoundingClientRect().height || 0);
      document.documentElement.style.setProperty('--nav-offset', h + 'px');
    }
    function init(){
      const topEl = findTopbar();
      applyOffset(topEl);
      if (topEl && 'ResizeObserver' in window) {
        const ro = new ResizeObserver(()=>applyOffset(topEl));
        ro.observe(topEl);
      }
      window.addEventListener('orientationchange', ()=>applyOffset(topEl), { passive:true });
      window.addEventListener('resize', ()=>applyOffset(topEl), { passive:true });
    }
    if (document.readyState === 'complete') init();
    else window.addEventListener('load', init);
  })();
  </script>

  <main class="wrap">
    <section class="card" role="form" aria-labelledby="title">
      <div class="title-row">
        <h1 id="title" style="padding-left:1ch">Email our support team</h1>
        <button class="link" id="copyBtn" title="Copy address">naptioai@gmail.com</button>
      </div>

      <div class="row">
        <label for="subject">Subject</label>
        <input id="subject" type="text" placeholder="Brief summary (e.g., Pairing issue)" />
      </div>

      <div class="row">
        <label for="message">Message</label>
        <textarea id="message" placeholder="Tell us what’s happening…" required></textarea>
      </div>

      <div class="row" id="attachRow">
        <label for="files">Attachments (optional)</label>
        <div id="drop" class="drop" tabindex="0" aria-label="Add files by dropping or choosing">
          <p><button type="button" class="link" id="browseBtn">Choose files</button> or drag & drop here</p>
          <input id="files" type="file" multiple hidden />
          <div class="chips" id="chips"></div>
        </div>
      </div>

      <div class="row">
        <label class="checkbox">
          <input id="includeDiag" type="checkbox" />
          <span>Include diagnostic info at the end (OS, device, browser, screen, etc.)</span>
        </label>
        <p class="small">Helpful for reproducing issues. You can leave this unchecked.</p>
      </div>

      <p class="error" id="err"></p>

      <div class="actions">
        <button class="btn" id="emailBtn">Email support</button>
      </div>
      <p class="hint" id="modeHint"></p>
    </section>
  </main>

  <script>
  (function(){
    const TO = 'naptioai@gmail.com';
    const CID = genId(); // short correlation id

    // Elements
    const subjectEl   = document.getElementById('subject');
    const messageEl   = document.getElementById('message');
    const errEl       = document.getElementById('err');
    const emailBtn    = document.getElementById('emailBtn');
    const copyBtn     = document.getElementById('copyBtn');
    const hintEl      = document.getElementById('modeHint');
    const includeDiag = document.getElementById('includeDiag');

    // Attachments UI
    const attachRow  = document.getElementById('attachRow');
    const drop       = document.getElementById('drop');
    const filesInput = document.getElementById('files');
    const chips      = document.getElementById('chips');
    const browseBtn  = document.getElementById('browseBtn');

    // Platform helpers
    const ua = navigator.userAgent || '';
    const isIOS = /iP(hone|od|ad)/.test(ua) || (/Mac/.test(navigator.platform) && 'ontouchend' in document);
    const isAndroid = /Android/i.test(ua);

    // Web Share with files availability
    let canShareFiles = false;
    try {
      const test = new File([new Blob(['x'], {type:'text/plain'})], 'x.txt', {type:'text/plain'});
      canShareFiles = !!(navigator.canShare && navigator.canShare({ files: [test] }));
    } catch { canShareFiles = false; }

    // Persistent list of selected attachments
    let selectedFiles = []; // Array<File>
    const MAX_FILES = 5;

    if (!canShareFiles) attachRow.style.display = 'none';

    // Events
    messageEl.addEventListener('input', validate);
    browseBtn.addEventListener('click', () => filesInput.click());

    filesInput.addEventListener('change', (e) => {
      addFiles([...(e.target.files || [])]);
      e.target.value = ''; // allow re-select same file
    });

    ['dragenter','dragover'].forEach(ev => drop.addEventListener(ev, (e)=>{ e.preventDefault(); drop.classList.add('over'); }));
    ['dragleave','drop'].forEach(ev => drop.addEventListener(ev, (e)=>{ e.preventDefault(); drop.classList.remove('over'); }));
    drop.addEventListener('drop', (e) => {
      addFiles([...(e.dataTransfer?.files || [])]);
    });

    emailBtn.addEventListener('click', async () => {
      if (!validate()) return;

      const hasFiles = selectedFiles.length > 0;
      const subject = composeSubject();
      const body    = await composeBodyWithDiagnostics();

      if (hasFiles && canShareFiles && navigator.share) {
        try {
          // Mobile convenience: copy address for quick paste into To:
          try { await navigator.clipboard.writeText(TO); } catch {}
          await navigator.share({ title: subject, text: body, files: selectedFiles });
        } catch {
          openMailto(subject, body);
        }
      } else {
        openMailto(subject, body);
      }
    });

    copyBtn.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(TO); copyBtn.textContent = 'Copied!'; setTimeout(()=>copyBtn.textContent = TO, 1200); } catch {}
    });

    // ---- File helpers ----
    function addFiles(files){
      for (const f of files) {
        if (selectedFiles.length >= MAX_FILES) break;
        const exists = selectedFiles.some(g => g.name === f.name && g.size === f.size && g.lastModified === f.lastModified);
        if (!exists) selectedFiles.push(f);
      }
      renderChips();
      updateModeLabel();
      try {
        const dt = new DataTransfer();
        selectedFiles.forEach(f => dt.items.add(f));
        filesInput.files = dt.files;
      } catch {}
    }

    function removeAt(i){
      selectedFiles.splice(i,1);
      renderChips(); updateModeLabel();
      try {
        const dt = new DataTransfer();
        selectedFiles.forEach(f => dt.items.add(f));
        filesInput.files = dt.files;
      } catch {}
    }

    function renderChips(){
      chips.innerHTML = '';
      selectedFiles.forEach((f, i) => {
        const chip = document.createElement('span'); chip.className='chip';
        chip.innerHTML = `<span>${f.name} • ${fmtBytes(f.size)}</span>`;
        const x = document.createElement('button'); x.type='button'; x.setAttribute('aria-label','Remove'); x.textContent='×';
        x.onclick = () => removeAt(i);
        chip.appendChild(x);
        chips.appendChild(chip);
      });
    }

    // ---- Email helpers ----
    function openMailto(subject, body){
      const url = `mailto:${encodeURIComponent(TO)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.location.href = url;
    }
    function composeSubject(){ return subjectEl.value.trim() || 'Support request'; }

    async function composeBodyWithDiagnostics(){
      const userText = messageEl.value.trim();
      if (!includeDiag.checked) return userText;

      const diag = await collectDiagnostics();
      const toMB = (b) => (typeof b === 'number' ? Math.round(b/1048576) + 'MB' : 'n/a');
      const dev = diag.env.devices || {};
      const perf = diag.env.perfNav || {};
      const paints = diag.env.paints || {};
      const gpu = diag.env.gpu || {};
      const storage = diag.env.storage || {};
      const pwa = diag.env.pwa || {};
      const vv = diag.env.viewport2 || {};

      const lines = [
        '',
        '— — — — —',
        //`cid: ${diag.cid}`,
        'Diagnostics',
        `Time: ${diag.time.local} (${diag.time.tz}, UTC${(diag.time.offsetMin>=0?'+':'')}${(diag.time.offsetMin/60).toFixed(0)})`,
        `URL: ${location.href}`,
        `UA: ${diag.env.ua}`,
        diag.env.hints ? `UA-CH: ${JSON.stringify(diag.env.hints)}` : null,
        `Platform: ${diag.env.platform || 'n/a'} (${diag.env.vendor || 'vendor n/a'})`,
        `Language: ${diag.env.lang}`,
        `Device: memory=${diag.env.memory ?? 'n/a'}GB cores=${diag.env.cores ?? 'n/a'}`,
        `Screen: ${diag.env.screen.w}x${diag.env.screen.h} @${diag.env.screen.dpr} ${diag.env.screen.orient || ''}`.trim(),
        `Viewport: ${diag.env.viewport.w}x${diag.env.viewport.h} scale=${vv.scale ?? 1}`,
        `Prefs: motion=${vv.prefersReducedMotion ? 'reduce' : 'no-preference'} scheme=${vv.colorScheme || 'n/a'}`,
        `Network: online=${diag.env.online} downlink=${diag.env.conn ? diag.env.conn.downlink : 'n/a'}Mbps rtt=${diag.env.conn ? diag.env.conn.rtt : 'n/a'}ms saveData=${diag.env.conn ? diag.env.conn.saveData : 'n/a'} type=${diag.env.conn ? diag.env.conn.type : 'n/a'}`,
        diag.env.battery ? `Battery: ${Math.round(diag.env.battery.level*100)}% ${diag.env.battery.charging?'(charging)':''}` : null,
        `Permissions: camera=${diag.env.camPerm || 'n/a'} mic=${diag.env.micPerm || 'n/a'}`,
        `Security: https=${diag.env.secure} coi=${diag.env.coi} dnt=${diag.env.dnt}`,
        (gpu.vendor || gpu.renderer) ? `GPU: ${[gpu.vendor,gpu.renderer].filter(Boolean).join(' / ')}` : null,
        (storage.usage || storage.quota) ? `Storage: ${toMB(storage.usage)}/${toMB(storage.quota)}` : null,
        `PWA: standalone=${pwa.standalone ? 1 : 0} sw=${pwa.sw ? 1 : 0}`,
        (dev.ai!=null || dev.vi!=null || dev.ao!=null) ? `Devices: mic=${dev.ai ?? 0} cam=${dev.vi ?? 0} spk=${dev.ao ?? 0}` : null,
        (perf.ttfb!=null || paints['first-contentful-paint']!=null) ? `Perf: ttfb=${Math.round(perf.ttfb||0)}ms fcp=${paints['first-contentful-paint'] ?? 'n/a'}ms dcl=${Math.round(perf.domContentLoaded||0)}ms load=${Math.round(perf.loadEventEnd||0)}ms` : null,
        diag.rtc ? `RTC: a=${diag.rtc.audio?.bitrateKbps ?? 0}kbps v=${diag.rtc.video?.bitrateKbps ?? 0}kbps fps=${diag.rtc.video?.fps ?? 0} iceRelay=${diag.rtc.ice?.relay ? 1 : 0}` : null
      ].filter(Boolean);

      const MAX = 2500;
      const out = userText + '\n\n' + lines.join('\n');
      return out.length > MAX ? out.slice(0, MAX) + '\n…(truncated)' : out;
    }

    // ---- Diagnostics collection ----
    async function collectDiagnostics(){
      const nav = navigator;
      const ua = nav.userAgent || '';
      const hints = nav.userAgentData ? { brands: nav.userAgentData.brands, mobile: nav.userAgentData.mobile, platform: nav.userAgentData.platform } : null;

      const memory = 'deviceMemory' in nav ? nav.deviceMemory : undefined;
      const cores = 'hardwareConcurrency' in nav ? nav.hardwareConcurrency : undefined;
      const lang = nav.language;
      const vendor = nav.vendor;
      const platform = nav.platform;

      const screenInfo = { w: screen.width, h: screen.height, dpr: devicePixelRatio, orient: (screen.orientation && screen.orientation.type) || undefined };
      const viewport = { w: window.innerWidth, h: window.innerHeight };

      const conn = nav.connection ? { downlink: nav.connection.downlink, rtt: nav.connection.rtt, saveData: nav.connection.saveData, type: nav.connection.type } : null;

      let battery = null;
      try { if (nav.getBattery) { const b = await nav.getBattery(); battery = { charging: b.charging, level: b.level }; } } catch {}

      let camPerm, micPerm;
      try { if (navigator.permissions) camPerm = (await navigator.permissions.query({ name: 'camera' })).state; } catch {}
      try { if (navigator.permissions) micPerm = (await navigator.permissions.query({ name: 'microphone' })).state; } catch {}

      // Extras
      let gpu = null;
      try {
        const gl = document.createElement('canvas').getContext('webgl');
        const dbg = gl && gl.getExtension('WEBGL_debug_renderer_info');
        if (dbg) {
          gpu = {
            vendor:   (gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL)   || '').toString().slice(0,80),
            renderer: (gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) || '').toString().slice(0,120)
          };
        }
      } catch {}

      let storage = null;
      try {
        if (navigator.storage?.estimate) {
          const { usage, quota } = await navigator.storage.estimate();
          storage = { usage, quota };
        }
      } catch {}

      const pwa = {
        standalone: window.matchMedia?.('(display-mode: standalone)').matches || (navigator.standalone === true),
        sw: !!navigator.serviceWorker?.controller
      };

      const viewport2 = {
        scale: window.visualViewport?.scale ?? 1,
        prefersReducedMotion: matchMedia('(prefers-reduced-motion: reduce)').matches,
        colorScheme: matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
      };

      let perfNav = null, paints = null;
      try {
        const n = performance.getEntriesByType('navigation')[0];
        if (n) {
          perfNav = {
            ttfb: n.responseStart,
            domContentLoaded: n.domContentLoadedEventEnd,
            loadEventEnd: n.loadEventEnd
          };
        }
        paints = {};
        for (const e of performance.getEntriesByType('paint')) {
          paints[e.name] = Math.round(e.startTime);
        }
      } catch {}

      // Device counts (no labels/ids)
      let devices = null;
      try {
        if (navigator.mediaDevices?.enumerateDevices) {
          const list = await navigator.mediaDevices.enumerateDevices();
          devices = { ai: 0, vi: 0, ao: 0 };
          for (const d of list) {
            if (d.kind === 'audioinput') devices.ai++;
            else if (d.kind === 'videoinput') devices.vi++;
            else if (d.kind === 'audiooutput') devices.ao++;
          }
        }
      } catch {}

      // Optional: summarized rtc stats if your app exposes it
      let rtc = null;
      try { rtc = await (window.__naptioRtcStats?.() ?? null); } catch {}

      const time = { local: new Date().toISOString(), tz: Intl.DateTimeFormat().resolvedOptions().timeZone, offsetMin: -new Date().getTimezoneOffset() };

      const env = {
        ua, hints, platform, vendor, lang, memory, cores, screen: screenInfo, viewport, conn, battery, camPerm, micPerm,
        // added:
        online: navigator.onLine,
        vis: document.visibilityState,
        focus: !!document.hasFocus?.(),
        secure: location.protocol === 'https:' ? 1 : 0,
        coi: !!window.crossOriginIsolated ? 1 : 0,
        dnt: (navigator.doNotTrack || '0'),
        gpu, storage, pwa, viewport2, perfNav, paints, devices
      };

      return { cid: CID, env, time, rtc };
    }

    // ---- UI state ----
    function validate(){
      errEl.classList.remove('show'); errEl.textContent = '';
      const ok = messageEl.value.trim().length > 0;
      emailBtn.disabled = !ok;
      return ok;
    }

    function updateModeLabel(){
      const hasFiles = selectedFiles.length > 0;
      if (hasFiles && canShareFiles) {
        emailBtn.textContent = 'Share email with attachments';
        hintEl.textContent = (isIOS || isAndroid)
          ? 'Your email app will open with files attached. You may need to enter the address.'
          : 'Your mail client will open with files attached. You may need to enter the address.';
      } else {
        emailBtn.textContent = 'Open email';
        //hintEl.textContent = 'Opens your email app with To/Subject/Message prefilled. Attachments aren’t included.';
      }
    }

    function fmtBytes(n){ if (n<1024) return n+' B'; const u=['KB','MB','GB']; let i=-1; do{ n/=1024; i++; } while(n>=1024&&i<u.length-1); return n.toFixed(1)+' '+u[i]; }
    function genId(){ const a=new Uint8Array(8); (crypto?.getRandomValues?.(a) ?? a.fill(Math.random()*255|0)); return [...a].map(b=>b.toString(16).padStart(2,'0')).join(''); }

    // init
    validate();
    updateModeLabel();
  })();
  </script>

  <!-- analytics -->
  <script type="module">
    import { installAnalytics } from '/hungryface/shared/analytics.js';
    window.analytics = installAnalytics({ feature: 'receiver-emailus' });
    // Later: window.analytics.event('emailus_opened');
  </script>
  
</body>
</html>
