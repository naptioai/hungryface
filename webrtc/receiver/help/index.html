<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Naptio — User Guide</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="description" content="Naptio User Guide — pairing, setup, and use of Camera (Baby) and Viewer (Parent) pages, including audio detection, movement & prone detection, alerts, and safety." />

  <!-- Shared sidebar stylesheet (same as Settings) -->
  <link rel="stylesheet" href="/hungryface/webrtc/receiver/shared/sidebar.css" />

  <style>
    :root { color-scheme: dark; }
    html, body {
      margin: 0; background: #000; color: #fff;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      height: 100%;
      touch-action: manipulation;
      overflow-x: hidden;
    }

    /* Layout */
    #ui {
      position: relative; z-index: 5; min-height: 100svh;
      display: flex; align-items: flex-start; justify-content: center;
      padding: 20px;
      transition: padding-left .18s ease;
      will-change: padding-left;
      box-sizing: border-box;
    }
    .panel {
      width: 100%; max-width: 1100px;
      background: #0b0b0b; color: #eaeaea;
      border: 1px solid #1b1b1b; border-radius: 16px;
      box-shadow: 0 0 0 1px #0a0a0a inset, 0 8px 24px rgba(0,0,0,0.5);
      padding: 20px 16px 40px;
      box-sizing: border-box;
    }
    @media (min-width: 720px) {
      .panel { padding: 28px 28px 52px; }
    }

    /* Header (NOT sticky; scrolls away) */
    .header {
      padding: 10px 0 12px;
      margin: 0 0 18px;
      border-bottom: 1px solid #141414;
    }
    .header-row { display: flex; align-items: center; gap: 12px; }
    h1 { margin: 0; font-size: 22px; letter-spacing: .2px; color: #fff; }
    @media (min-width: 720px) { h1 { font-size: 26px; } }

    /* Content */
    h2 { font-size: 20px; margin: 26px 0 10px; color: #fff; }
    h3 { font-size: 17px; margin: 18px 0 8px; color: #fff; }
    p { line-height: 1.6; margin: 10px 0; color: #e1e1e1; }
    ul, ol { margin: 8px 0 14px 20px; }
    li { margin: 6px 0; }
    hr { border: 0; height: 1px; background: #161616; margin: 18px 0; }

    .muted { color: #bdbdbd; }
    .inline-code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      background: #121212; border: 1px solid #1c1c1c; padding: 2px 6px; border-radius: 8px;
      color: #ddd;
    }
    .note, .tip, .warn {
      border-radius: 12px; padding: 10px 12px; margin: 10px 0 14px;
      border: 1px solid;
    }
    .note { background:#0f1117; border-color:#1b2130; }
    .tip  { background:#10170f; border-color:#19301b; }
    .warn { background:#17100f; border-color:#30211b; }

    .quick-card {
      border: 1px solid #1b1b1b; border-radius: 14px;
      background: #0a0a0a;
      padding: 14px 14px 2px; margin: 8px 0 16px;
    }
    .pill {
      display:inline-block; padding: 6px 10px; border-radius: 999px;
      border: 1px solid #1f1f1f; background:#0f0f0f; color:#e8e8e8; font-size:12px;
      margin: 0 6px 0 0;
    }
    a { color: #fff; text-decoration: none; opacity: 0.95; }
    a:hover { text-decoration: underline; opacity: 1; }
    .toc a { color:#dcdcdc; }
    .toc { border:1px solid #1b1b1b; background:#0a0a0a; border-radius:12px; padding:10px 12px; }
  </style>

  <!-- --- Sidebar overlap fix CSS (copied from Settings pattern) --- -->
  <style>
    :root {
      --sidebar-visible: 0px;
      --sidebar-gutter: 12px;                     /* spacing from drawer edge */
      --safe-left: env(safe-area-inset-left, 0px);/* iPhone gesture area */
      --menu-hit: 52px;                           /* tappable area for hamburger */
      --sidebar-offset: calc(var(--sidebar-visible) + var(--safe-left) + var(--sidebar-gutter));
    }
    /* Shift content so it never sits under the drawer */
    #ui { padding-left: var(--sidebar-offset); }
    /* Keep panel within remaining width */
    .panel { max-width: min(1100px, calc(100vw - var(--sidebar-offset) - 32px)); }

    @media (max-width: 480px) {
      /* On very small screens, don't push content when the drawer opens */
      body.drawer-open-detected #ui { padding-left: 0 !important; }
      .panel { max-width: min(1100px, calc(100vw - 32px)); }
    }
  </style>
</head>
<body>
  <!-- Shared sidebar injection (same as Settings) -->
  <script type="module">
    (async () => {
      try {
        const res = await fetch('/hungryface/webrtc/receiver/shared/sidebar.html', { cache: 'no-cache' });
        const html = await res.text();
        const wrap = document.createElement('div');
        wrap.innerHTML = html.trim();
        document.body.prepend(...wrap.childNodes);

        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = '/hungryface/webrtc/receiver/shared/sidebar.js';
          s.onload = resolve;
          s.onerror = reject;
          document.body.appendChild(s);
        });
      } catch (err) {
        console.error('[Sidebar] failed to load shared assets:', err);
      }
    })();
  </script>

  <!-- Sidebar visible-width measurer (same logic as Settings) -->
  <script type="module">
    (function () {
      const root = document.documentElement;
      let sidebar = null;
      let ro = null, mo = null;
      let rafId = 0;

      function px(n) { return Math.max(0, Math.round(n)) + 'px'; }

      function pickSidebarCandidate() {
        const preferred = document.querySelector(
          '[data-hf-sidebar], [data-sidebar], .hf-sidebar, #hfSidebar, #sidebar, .sidebar, aside[role="complementary"], nav[aria-label="Sidebar"]'
        );
        if (preferred) return preferred;

        const nodes = Array.from(document.body.querySelectorAll('body > *'));
        return nodes.find(el => {
          const cs = getComputedStyle(el);
          if (cs.position !== 'fixed') return false;
          if (!(/^0(px)?$/).test(cs.left)) return false;
          const r = el.getBoundingClientRect();
          const w = r.width;
          return w >= 160 && w <= window.innerWidth * 0.9;
        }) || null;
      }

      function visibleLeftWidth(el) {
        const r = el.getBoundingClientRect();
        const visible = Math.max(0, Math.min(window.innerWidth, r.right) - Math.max(0, r.left));
        const cs = getComputedStyle(el);
        const displayOK = cs.display !== 'none' && cs.visibility !== 'hidden' && r.height > 0;
        return displayOK && r.left < (window.innerWidth / 2) ? visible : 0;
      }

      function updateShift() {
        rafId && cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(() => {
          const w = sidebar ? visibleLeftWidth(sidebar) : 0;
          root.style.setProperty('--sidebar-visible', px(w));
          document.body.classList.toggle('drawer-open-detected', w > 8);
        });
      }

      function attachObservers() {
        if (!sidebar) return;
        try { ro?.disconnect(); mo?.disconnect(); } catch {}
        ro = new ResizeObserver(updateShift);
        ro.observe(sidebar);
        mo = new MutationObserver(updateShift);
        mo.observe(sidebar, { attributes: true, attributeFilter: ['style', 'class', 'hidden', 'inert'], subtree: false });
      }

      function boot() {
        sidebar = pickSidebarCandidate();
        if (!sidebar) { setTimeout(boot, 120); return; }
        attachObservers();
        updateShift();
      }

      ['resize','orientationchange'].forEach(ev => window.addEventListener(ev, updateShift, { passive: true }));
      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', updateShift, { passive: true });
        window.visualViewport.addEventListener('scroll',  updateShift, { passive: true });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', boot, { once: true });
      } else {
        boot();
      }
    })();
  </script>

  <div id="ui">
    <main class="panel" role="main">
      <div class="header">
        <div class="header-row">
          <h1 style="padding-left:3ch">User guide</h1>
        </div>
      </div>

      <p class="muted">
        Naptio turns two devices into a privacy-first baby monitor. Video and audio stream directly between your devices over WebRTC, and on-device AI helps surface useful cues (cry-like sounds, movement, face-down/prone risk). There’s no cloud video storage.
      </p>

      <div class="toc" aria-label="On this page">
        <div class="pill">Quick nav</div>
        <a href="#need">What you need</a> •
        <a href="#tldr">Quick start</a> •
        <a href="#qstart">One-page Quick Start</a> •
        <a href="#pairing">Pairing (PSK)</a> •
        <a href="#camera">Start the Camera</a> •
        <a href="#receivers">Receivers</a> •
        <a href="#audio">Audio: train &amp; detect</a> •
        <a href="#movement">Movement</a> •
        <a href="#prone">Prone</a> •
        <a href="#fence">Fence</a> •
        <a href="#video">Video viewer</a> •
        <a href="#alerts">Alerts</a> •
        <a href="#settings">Settings</a> •
        <a href="#troubleshooting">Tips &amp; troubleshooting</a> •
        <a href="#privacy">Privacy &amp; safety</a> •
        <a href="#support">Support</a> •
        <a href="#appendix">Appendix</a>
      </div>

      <!-- ======== Rest of your existing content unchanged ======== -->
      <h2 id="need">1) What you need</h2>
      <ul>
        <li>Two devices (e.g., an old phone as the <strong>Camera (Baby)</strong> and your phone/tablet as the <strong>Viewer (Parent)</strong>).</li>
        <li>A stable Wi-Fi network or proximity for peer-to-peer; WebRTC will try STUN/TURN relays if needed.</li>
        <li>Modern browser (Chrome, Edge, Safari, or Firefox). Allow camera/microphone permissions.</li>
      </ul>
      <hr/>

      <h2 id="tldr">2) Quick start</h2>
      <ol>
        <li><strong>Pair the devices once</strong> using <em>Pair devices → Share</em> on the Camera device, then open the share link (or scan the QR) on the Viewer device to <em>install</em> the secret.</li>
        <li>On the Camera device, open <em>Camera (Baby)</em> → pick <em>Back camera</em> → tap <em>Start streaming</em>.</li>
        <li>On the Viewer device, open a Receiver page (e.g., <em>Video</em>, <em>Audio – Live Detection</em>, <em>Movement</em>, or <em>Prone</em>) and press the page’s <em>Start/Enable</em> button.</li>
        <li>Keep devices powered and placed safely. Use <em>Alerts</em> and <em>Dashboard</em> to review events.</li>
      </ol>

      <h2 id="qstart">Summary</h2>
      <div class="quick-card">
        <p><strong>Roles:</strong> one device = <strong>Camera (Baby)</strong>, another = <strong>Viewer (Parent)</strong>.</p>
        <ol>
          <li><strong>Pair once</strong><br/>
            • On the Camera, open <em>Pair devices (Share)</em> → <em>Share</em> or <em>Copy</em>.<br/>
            • On the Viewer, open that link (or scan the QR) → <em>Pair devices (Install)</em> shows <em>Key installed</em>.
          </li>
          <li><strong>Start the Camera</strong><br/>
            • Open <em>Camera (Baby)</em> → pick <em>Room</em> and <em>Back camera</em> → <em>Start streaming</em>.<br/>
            • Leave it plugged in, screen dimmed, safely away from the crib.
          </li>
          <li><strong>Open a Viewer</strong><br/>
            • Use <em>Video</em>, <em>Audio – Live detection</em>, <em>Movement</em>, <em>Prone</em>, or <em>Fence</em>.<br/>
            • Hit <em>Start/Enable</em> on each page. Use the left hamburger to switch pages.
          </li>
          <li><strong>Calibrate</strong> (strongly recommended)<br/>
            • <em>Audio (quiet)</em>: run 20–30s in a quiet room to set ON/OFF thresholds.<br/>
            • <em>Movement</em>: run <em>Calibration</em> while baby is still to seed the baseline.<br/>
            • <em>Prone</em>: run <em>Supine baseline</em> with baby face-up.
          </li>
          <li><strong>Alerts &amp; history</strong><br/>
            • Red banner shows the latest alert; open the <em>Alerts drawer</em> for history.<br/>
            • Use the <em>Dashboard</em> to see timelines (15m, 2h, 8h, 24h, 7d), filter, and export.
          </li>
          <li><strong>Safety &amp; privacy</strong><br/>
            • Naptio is not a medical device; keep constant adult supervision.<br/>
            • Streams stay device-to-device; secrets live only on your devices.<br/>
            • Rotate or forget the room secret anytime.
          </li>
        </ol>
      </div>
      <hr/>

      <!-- (All remaining sections unchanged) -->
      <!-- Pairing / Camera / Receivers / Audio / Movement / Prone / Fence / Video / Alerts / Settings / Troubleshooting / Privacy / Support / Appendix -->
      <!-- ... (keep your existing content here) ... -->
      
      <h2 id="pairing">3) Pairing devices (PSK secret)</h2>
      <!-- keep the rest of your original markup from here on -->
      <!-- ... -->
    </main>
  </div>
</body>
</html>
